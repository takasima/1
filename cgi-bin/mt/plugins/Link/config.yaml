name: Link
id: Link
key: link
version: 1.9
schema_version: 0.297
author_name: Alfasado Inc.
author_link: http://alfasado.net/
l10n_class: Link::L10N
description: <__trans phrase="Manage Link and Link Group.">
config_settings:
    DoScheduledLinkCheck:
        default: 0
    DoSavedLinkCheck:
        default: 0
    LinkCustomFieldScope:
        default: blog
customfield_types: $link::Link::Field::_customfield_types
settings:
    check_outlink:
        Default: 1
    use_wysiwyg:
        Default: 1
    editor_style_css:
        Default: <$MTStaticWebPath$>plugins/TinyMCE/css/editor_style.css
    theme_advanced_buttons1:
        Default: 'bold,|,justifyleft,justifycenter,justifyright,|,bullist,|,forecolor,|,indent,outdent,|,link,unlink,styleselect,formatselect,removeformat'
    theme_advanced_buttons2:
        Default: 'pastetext,pasteword,|,tablecontrols,|,mt-image,mt-file,|,fullscreen,|,code'
    theme_advanced_buttons3:
    theme_advanced_buttons4:
    theme_advanced_buttons5:
    default_module_mtml:
blog_config_template: link_config.tmpl
listing_screens:
    link:
        object_label: Link
        primary: name
        default_sort_key: name
        condition: $link::Link::Plugin::_link_permission
        view:
            - website
            - blog
            - system
    linkgroup:
        object_label: Link Group
        primary: name
        default_sort_key: name
        condition: $link::Link::Plugin::_group_permission
        view:
            - website
            - blog
            - system
list_properties:
    link: $link::Link::Listing::list_props
    linkgroup: $link::Link::Listing::list_props_group
    tag: $link::Link::Listing::list_props_tag
system_filters:
    link: $link::Link::Listing::system_filters_link
    linkgroup: $link::Link::Listing::system_filters_linkgroup
    tag: $link::Link::Listing::system_filters_tag
list_actions:
    link: $link::Link::Listing::list_actions
    linkgroup: $link::Link::Listing::list_group_actions
content_actions:
    link: $link::Link::Listing::content_actions
applications:
    cms:
        menus:
            link:
                label: Link
                order: 470
            link:list_link:
                label: Manage
                mode: list
                args:
                    blog_id: 0
                    _type: link
                order: 1
                condition: $link::Link::Plugin::_link_permission
                view:
                    - website
                    - blog
                    - system
            link:create_link:
                label: New
                mode: view
                args:
                    _type: link
                order: 2
                condition: $link::Link::Plugin::_link_permission
                view:
                    - website
                    - blog
            link:list_linkgroup:
                label: Manage Groups
                mode: list
                args:
                    blog_id: 0
                    _type: linkgroup
                order: 3
                condition: $link::Link::Plugin::_group_permission
                view:
                    - website
                    - blog
                    - system
            link:create_linkgroup:
                label: Create Group
                mode: view
                args:
                    _type: linkgroup
                order: 4
                condition: $link::Link::Plugin::_group_permission
                view:
                    - website
                    - blog
            link:edit_tags:
                label: Tags
                mode: list
                args:
                    _type: tag
                    filter_key: link
                order: 5
                permission: edit_tags
                view:
                    - website
                    - blog
        compose_menus:
            link:
                label: Link
                order: 900
                mode: view
                args:
                    _type: link
                view:
                    - website
                    - blog
                condition: $link::Link::Plugin::_link_permission
        methods:
#            list_link: $link::Link::Plugin::_list_link
#            list_linkgroup: $link::Link::Plugin::_list_link
            upload_link: $link::Link::Plugin::_upload_link
            download_link_csv: $link::Link::Plugin::_download_link_csv
            publish_links: $link::Link::Plugin::_publish_links
            unpublish_links: $link::Link::Plugin::_unpublish_links
            action_link_check: $link::Link::Plugin::_action_link_check
            view_link: $link::Link::Plugin::_view_link
            view_linkgroup: $link::Link::Plugin::_view_link
            add_tags_to_link: $link::Link::Plugin::_add_tags_to_link
            remove_tags_to_link: $link::Link::Plugin::_remove_tags_to_link
search_apis:
    link:
        handler: $link::Link::Plugin::_search_link
        condition: >
            sub {
                my $app = MT->instance;
                if ( $app->user->is_superuser ) {
                    return 1;
                }
                if ( my $blog = $app->blog ) {
                    if ( $blog->is_blog ) {
                        return Link::Plugin::_link_permission( $blog );
                    } else {
                        my $blogs = $blog->blogs;
                        for my $b ( @$blogs ) {
                            if ( Link::Plugin::_link_permission( $b ) ) {
                                return 1;
                                last;
                            }
                        };
                    }
                }
            }
        perm_check: $link::Link::Plugin::_link_permission
        order: 700
        label: Link
        can_replace: 0
        can_search_by_date: 1
        date_column: authored_on
        search_cols:
            name: Name
            notes: Notes
            description: Description
            url: URL
            rss_address: RSS URL
            image_address: Image URL
            title: title
        setup_terms_args: >
            sub {
                my ( $terms, $args, $blog_id ) = @_;
                require Link::Plugin;
                my $app = MT->instance;
                if ( my $blog = $app->blog ) {
                    if ( $blog->is_blog ) {
                        $terms->{ blog_id } = $blog_id;
                    } else {
                        my @ids;
                        push ( @ids, $blog_id );
                        my $blogs = $blog->blogs;
                        for my $b ( @$blogs ) {
                            if ( Link::Plugin::_link_permission( $b ) ) {
                                push ( @ids, $b->id )
                            }
                        };
                        $terms->{ blog_id } = \@ids;
                    }
                } else {
                    if (! $app->user->is_superuser ) {
                        require MT::Blog;
                        my $all_blogs = MT::Blog->load( { class => '*' } );
                        my @ids;
                        for my $b ( @$all_blogs ) {
                            if ( Link::Plugin::_link_permission( $b ) ) {
                                push ( @ids, $b->id );
                            }
                        }
                        $terms->{ blog_id } = \@ids;
                    }
                }
            }
        results_table_template: include/link_table.tmpl
object_types:
    link: Link::Link
    linkgroup: Link::LinkGroup
    linkorder: Link::LinkOrder
permissions:
    blog.manage_link:
        label: Edit Link
        group: auth_pub
        order: 1000
    blog.manage_linkgroup:
        label: Manage Link Group
        group: blog_admin
        order: 1000
callbacks:
    init_app:
        handler: $link::Link::Field::_init_tags
        priority: 10
    init_request: $link::Link::Plugin::_init_request
    MT::App::CMS::pre_run: $link::Link::Plugin::_pre_run
    MT::App::CMS::template_param.edit_link: $link::Link::Plugin::_edit_link
    MT::App::CMS::template_param.edit_linkgroup: $link::Link::Plugin::_edit_linkgroup
    MT::App::CMS::template_param.edit_template: $link::Link::Plugin::_edit_template_param
    MT::App::CMS::template_param.asset_insert:
        handler: $link::Link::Plugin::_asset_insert
        priority: 10
    MT::App::CMS::template_param.list_tag: $link::Link::Plugin::_list_tag
    cms_post_save.template: $link::Link::Plugin::_cms_post_save_template
    cms_post_delete.template: $link::Link::Plugin::_cms_post_delete_template
    #blog_template_set_change: $link::Link::Plugin::_install_role
    MT::App::Upgrader::post_run: $link::Link::Plugin::_upgrader_post_run
    list_template_param.link: $link::Link::Listing::_list_template_param
    list_template_param.linkgroup: $link::Link::Listing::_list_template_param_group
    cms_pre_load_filtered_list.link: $link::Link::Listing::_cms_pre_load_filtered_list
    cms_pre_load_filtered_list.linkgroup: $link::Link::Listing::_cms_pre_load_filtered_list
    save_permission_filter.linkorder: sub { MT->instance->error( MT->translate( 'Invalid request.' ) ); }
    delete_permission_filter.linkorder: sub { MT->instance->error( MT->translate( 'Invalid request.' ) ); }
    MT::Blog::post_clone: 
        handler: $link::Link::Plugin::clone_object
        priority: 6
    template_param.clone_blog: $link::Link::Plugin::clone_blog
    restore: $link::Link::Plugin::_cb_restore
    tasks:
        - handler: $link::Link::Field::_init_tags
          priority: 1
upgrade_functions:
    install_role_link:
        plugin: Link
        code: $link::Link::Plugin::_install_role
    install_role_link_nv:
        plugin: Link
        version_limit: 0.297
        code: $link::Link::Plugin::_install_role
tasks:
    scheduled_link_check:
        label: Link check task
        frequency: 3600
        code: $link::Link::Plugin::_task_link_check
        priority: 5
    link_adjust_order:
        label: Cleanup order
        code: $link::Link::Plugin::_task_adjust_order
        frequency: 180
tags:
    block:
        Links: $link::Link::Tags::_hdlr_links
        LinkBlock: $link::Link::Tags::_hdlr_link
        LinksHeader: $link::Link::Tags::_hdlr_pass_tokens
        LinksFooter: $link::Link::Tags::_hdlr_pass_tokens
        LinkTags: $link::Link::Tags::_hdlr_link_tags
        LinkAuthor: $link::Link::Tags::_hdlr_link_author
        LinkIfTagged?: $link::Link::Tags::_hdlr_if_link_tagged
        IfBrokenLink?: $link::Link::Tags::_hdlr_if_link_broken
        IfBrokenRSS?: $link::Link::Tags::_hdlr_if_link_broken
        IfBrokenImage?: $link::Link::Tags::_hdlr_if_link_broken
        IfActiveLink?: $link::Link::Tags::_hdlr_if_link_active
        IfActiveRSS?: $link::Link::Tags::_hdlr_if_link_active
        IfActiveImage?: $link::Link::Tags::_hdlr_if_link_active
    function:
        LinkBlogID: $link::Link::Tags::_hdlr_link_column
        LinkName: $link::Link::Tags::_hdlr_link_column
        LinkHTML: $link::Link::Tags::_hdlr_link_html
        LinkAuthorDisplayName: $link::Link::Tags::_hdlr_author_displayname
        LinkURL: $link::Link::Tags::_hdlr_link_column
        LinkDescription: $link::Link::Tags::_hdlr_link_column
        LinkTitle: $link::Link::Tags::_hdlr_link_column
        LinkTarget: $link::Link::Tags::_hdlr_link_column
        LinkRel: $link::Link::Tags::_hdlr_link_column
        LinkImageAddress: $link::Link::Tags::_hdlr_link_column
        LinkRSSAddress: $link::Link::Tags::_hdlr_link_column
        LinkNotes: $link::Link::Tags::_hdlr_link_column
        LinkRating: $link::Link::Tags::_hdlr_link_column
        LinkAuthoredOn: $link::Link::Tags::_hdlr_link_date
        LinkCreatedOn: $link::Link::Tags::_hdlr_link_date
        LinkModifiedOn: $link::Link::Tags::_hdlr_link_date
        LinkURLUpdatedOn: $link::Link::Tags::_hdlr_link_date
        LinkRSSUpdatedOn: $link::Link::Tags::_hdlr_link_date
        LinkFieldScope: $link::Link::Tags::_hdlr_link_field_scope
backup_instructions:
    link:
        order: 505
    linkgroup:
        order: 550
    linkorder:
        order: 560
